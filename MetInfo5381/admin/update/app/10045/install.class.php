<?php
defined('IN_MET') or exit ('No permission'); class install { public function __construct(){  $this->appNo=10045; $this->vers=array('1.0'); sort($this->vers); $this->new_ver='1.0'; } public function dosql() { global $_M; $app=DB::get_one("SELECT * FROM {$_M['table']['applist']} WHERE `no`='{$this->appNo}'"); if(empty($app)||empty($app['ver'])){ $sql="INSERT INTO {$_M['table']['applist']} (`no`,ver,m_name,m_class,m_action,appname,info,addtime,updatetime) VALUES ('{$this->appNo}','{$this->new_ver}','zorlan_wenzhangcaiji','wenzhangcaiji','doindex','文章采集','输入文章网址自动抓取文章标题和内容并发布到网站中！','{$timenow}','{$timenow}')"; DB::query($sql);} $cur_ver_index=-1; if(empty($app['ver'])){ $cur_ver_index=0; }else{ $cur_ver=$this->double_ver($app['ver']); foreach ($this->vers as $verk=>$verv){ if($app['ver']==$verv){ $cur_ver_index=$verk; break; }else{ $verv=$this->double_ver($verv); if($cur_ver<$verv){ $cur_ver_index=$verk-1; break; } } } } if($cur_ver_index>-1){ for($veri=$cur_ver_index+1;$veri<count($this->vers);$veri++){ $function_name='upgrade_to_'.str_replace('.', '_', $this->vers[$veri]); if(method_exists($this,$function_name)){ call_user_method($function_name, $this); } } } DB::query("UPDATE {$_M['table']['applist']} SET `ver`='{$this->new_ver}' WHERE `no`='{$this->appNo}'"); } public function double_ver($ver){ if($ver){ $doublever=''; $ver_num=explode('.', $ver); foreach ($ver_num as $k=>$v){ if($k==0){ $doublever.=$v.'.'; }else{ $doublever.=$v; } } $doublever=doubleval($doublever); }else{ $doublever=0; } return $doublever; } } ?>